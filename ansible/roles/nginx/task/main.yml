---
- name: Instalar Nginx e Certbot
  apt:
    name:
      - nginx
      - certbot
      - python3-certbot-nginx
    state: present
    update_cache: yes

# Etapa 1: configurar apenas HTTP
- name: Configurar Nginx sem SSL (apenas HTTP)
  template:
    src: nginx-http.conf.j2
    dest: /etc/nginx/sites-available/app
  notify: Reiniciar Nginx

- name: Ativar site
  file:
    src: /etc/nginx/sites-available/app
    dest: /etc/nginx/sites-enabled/app
    state: link
  notify: Reiniciar Nginx

- name: Remover default site
  file:
    path: /etc/nginx/sites-enabled/default
    state: absent
  notify: Reiniciar Nginx

- name: Garantir que Nginx estÃ¡ rodando antes do Certbot
  service:
    name: nginx
    state: started
    enabled: yes

# Etapa 2: gerar o certificado
- name: Obter certificado SSL
  command: >
    certbot --nginx --non-interactive --agree-tos
    -m {{ email_ssl }} -d {{ domain_name }}
  register: certbot_result
  ignore_errors: yes

# Etapa 3: reconfigurar com HTTPS se o certbot tiver sucesso
- name: Reconfigurar Nginx com HTTPS
  when: certbot_result.rc == 0
  template:
    src: nginx.conf.j2
    dest: /etc/nginx/sites-available/app
  notify: Reiniciar Nginx
# o notify a cima chama o arquivo que esta na pasta handlers/main.yml
